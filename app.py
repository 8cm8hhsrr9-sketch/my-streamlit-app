import streamlit as st
import requests

# =========================
# ê¸°ë³¸ ì„¤ì •
# =========================
st.set_page_config(page_title="ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?", page_icon="ğŸ¬")

st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write("ê°„ë‹¨í•œ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë‹¹ì‹ ì˜ ì„±í–¥ê³¼ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”!")

st.divider()

# =========================
# ì‚¬ì´ë“œë°” - TMDB API Key
# =========================
st.sidebar.header("ğŸ”‘ ì„¤ì •")
tmdb_api_key = st.sidebar.text_input("TMDB API Key", type="password")

# =========================
# ì§ˆë¬¸
# =========================
q1 = st.radio(
    "1ï¸âƒ£ ì£¼ë§ì— ì‹œê°„ì´ ìƒê¸°ë©´ ë‹¹ì‹ ì€?",
    [
        "ì§‘ì—ì„œ í˜¼ì ì—¬ìœ ë¥¼ ì¦ê¸´ë‹¤",
        "ì¹œí•œ ì‚¬ëŒê³¼ ë§Œë‚˜ ìˆ˜ë‹¤ë¥¼ ë–¤ë‹¤",
        "ì¦‰í¥ì ìœ¼ë¡œ ì–´ë”˜ê°€ ë– ë‚œë‹¤",
        "ìƒˆë¡œìš´ ì·¨ë¯¸ë‚˜ í™œë™ì„ í•´ë³¸ë‹¤"
    ]
)

q2 = st.radio(
    "2ï¸âƒ£ ì˜í™”ë¥¼ ë³¼ ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†ŒëŠ”?",
    [
        "íƒ„íƒ„í•œ ìŠ¤í† ë¦¬",
        "ê°ì •ì„ ì„ ìê·¹í•˜ëŠ” ì—°ì¶œ",
        "í™”ë ¤í•œ ì˜ìƒë¯¸",
        "ì›ƒê¸°ê±°ë‚˜ í†µì¾Œí•œ ì „ê°œ"
    ]
)

q3 = st.radio(
    "3ï¸âƒ£ ë‹¹ì‹ ì˜ ì„±ê²©ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì€?",
    [
        "ì°¨ë¶„í•˜ê³  í˜„ì‹¤ì ì¸ í¸",
        "ê°ì •ì´ í’ë¶€í•˜ê³  ê³µê°í˜•",
        "í˜¸ê¸°ì‹¬ ë§ê³  ëª¨í—˜ì ",
        "ìœ ì¾Œí•˜ê³  ë‚™ì²œì "
    ]
)

q4 = st.radio(
    "4ï¸âƒ£ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ë•Œ ë‹¹ì‹ ì€?",
    [
        "í˜¼ìë§Œì˜ ì‹œê°„ì´ í•„ìš”í•˜ë‹¤",
        "ëˆ„êµ°ê°€ì—ê²Œ í„¸ì–´ë†“ëŠ”ë‹¤",
        "ëª¸ì„ ì›€ì§ì´ë©° í‘¼ë‹¤",
        "ì›ƒê¸´ ê±¸ ë³´ë©° ìŠìœ¼ë ¤ í•œë‹¤"
    ]
)

q5 = st.radio(
    "5ï¸âƒ£ ì˜í™”ì˜ ê²°ë§ì€ ì–´ë–¤ ê²Œ ì¢‹ì„ê¹Œ?",
    [
        "í˜„ì‹¤ì ì´ê³  ì—¬ìš´ì´ ë‚¨ëŠ” ê²°ë§",
        "ê°ë™ì ì¸ í•´í”¼ì—”ë”©",
        "ì˜ˆìƒ ëª» í•œ ë°˜ì „",
        "ê°€ë³ê³  ì‹œì›í•œ ë§ˆë¬´ë¦¬"
    ]
)

st.divider()

# =========================
# ë‹µë³€ â†’ ì¥ë¥´ ë§¤í•‘
# =========================
genre_scores = {
    "ë“œë¼ë§ˆ": 0,
    "ë¡œë§¨ìŠ¤": 0,
    "ì•¡ì…˜": 0,
    "ì½”ë¯¸ë””": 0,
    "SF": 0,
    "íŒíƒ€ì§€": 0
}

answers = [q1, q2, q3, q4, q5]

for a in answers:
    if a in ["ì§‘ì—ì„œ í˜¼ì ì—¬ìœ ë¥¼ ì¦ê¸´ë‹¤", "íƒ„íƒ„í•œ ìŠ¤í† ë¦¬", "ì°¨ë¶„í•˜ê³  í˜„ì‹¤ì ì¸ í¸", "í˜„ì‹¤ì ì´ê³  ì—¬ìš´ì´ ë‚¨ëŠ” ê²°ë§"]:
        genre_scores["ë“œë¼ë§ˆ"] += 1
    if a in ["ê°ì •ì„ ì„ ìê·¹í•˜ëŠ” ì—°ì¶œ", "ê°ì •ì´ í’ë¶€í•˜ê³  ê³µê°í˜•", "ê°ë™ì ì¸ í•´í”¼ì—”ë”©"]:
        genre_scores["ë¡œë§¨ìŠ¤"] += 1
    if a in ["ì¦‰í¥ì ìœ¼ë¡œ ì–´ë”˜ê°€ ë– ë‚œë‹¤", "í˜¸ê¸°ì‹¬ ë§ê³  ëª¨í—˜ì ", "ì˜ˆìƒ ëª» í•œ ë°˜ì „"]:
        genre_scores["ì•¡ì…˜"] += 1
        genre_scores["SF"] += 1
    if a in ["ìœ ì¾Œí•˜ê³  ë‚™ì²œì ", "ì›ƒê¸°ê±°ë‚˜ í†µì¾Œí•œ ì „ê°œ", "ì›ƒê¸´ ê±¸ ë³´ë©° ìŠìœ¼ë ¤ í•œë‹¤", "ê°€ë³ê³  ì‹œì›í•œ ë§ˆë¬´ë¦¬"]:
        genre_scores["ì½”ë¯¸ë””"] += 1
    if a in ["í™”ë ¤í•œ ì˜ìƒë¯¸", "ìƒˆë¡œìš´ ì·¨ë¯¸ë‚˜ í™œë™ì„ í•´ë³¸ë‹¤"]:
        genre_scores["íŒíƒ€ì§€"] += 1

genre_id_map = {
    "ì•¡ì…˜": 28,
    "ì½”ë¯¸ë””": 35,
    "ë“œë¼ë§ˆ": 18,
    "SF": 878,
    "ë¡œë§¨ìŠ¤": 10749,
    "íŒíƒ€ì§€": 14
}

# =========================
# ê²°ê³¼ ë³´ê¸°
# =========================
if st.button("ğŸ¥ ê²°ê³¼ ë³´ê¸°"):
    if not tmdb_api_key:
        st.error("ì‚¬ì´ë“œë°”ì— TMDB API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        st.subheader("ğŸ” ë¶„ì„ ì¤‘...")
        
        selected_genre = max(genre_scores, key=genre_scores.get)
        genre_id = genre_id_map[selected_genre]

        st.write(f"ë‹¹ì‹ ì˜ ì„±í–¥ê³¼ ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” ì¥ë¥´ëŠ” **{selected_genre}** ì…ë‹ˆë‹¤.")

        url = (
            f"https://api.themoviedb.org/3/discover/movie"
            f"?api_key={tmdb_api_key}"
            f"&with_genres={genre_id}"
            f"&language=ko-KR"
            f"&sort_by=popularity.desc"
        )

        response = requests.get(url).json()
        movies = response.get("results", [])[:5]

        st.divider()
        st.subheader("ğŸ¬ ì¶”ì²œ ì˜í™”")

        for movie in movies:
            col1, col2 = st.columns([1, 3])

            with col1:
                if movie.get("poster_path"):
                    poster_url = "https://image.tmdb.org/t/p/w500" + movie["poster_path"]
                    st.image(poster_url, use_column_width=True)

            with col2:
                st.markdown(f"### {movie.get('title')}")
                st.write(f"â­ í‰ì : {movie.get('vote_average')}")
                st.write(movie.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."))
                st.caption(f"ğŸ’¡ ì´ ì˜í™”ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ : ë‹¹ì‹ ì˜ ì„±í–¥ì´ **{selected_genre}** ì¥ë¥´ì™€ ì˜ ì–´ìš¸ë¦¬ê¸° ë•Œë¬¸ì´ì—ìš”.")

            st.divider()
