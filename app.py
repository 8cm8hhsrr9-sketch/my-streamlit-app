import streamlit as st
import requests
import time

# =========================
# ê¸°ë³¸ ì„¤ì •
# =========================
st.set_page_config(page_title="ë‚˜ì™€ ë‹®ì€ ì˜í™” ì£¼ì¸ê³µì€?", page_icon="ğŸ­")

# =========================
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# =========================
if "page" not in st.session_state:
    st.session_state.page = "test"

if "result_data" not in st.session_state:
    st.session_state.result_data = None

# =========================
# ì‚¬ì´ë“œë°”
# =========================
st.sidebar.header("ğŸ”‘ ì„¤ì •")
tmdb_api_key = st.sidebar.text_input("TMDB API Key", type="password")

# ======================================================
# ğŸ§  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ í™”ë©´
# ======================================================
if st.session_state.page == "test":

    st.title("ğŸ­ ë‚˜ì™€ ë‹®ì€ ì˜í™” ì£¼ì¸ê³µì€?")
    st.write("ë‹¹ì‹ ê³¼ ê°€ì¥ ë¹„ìŠ·í•œ ì‚¬ëŒì´ ì£¼ì¸ê³µìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.")
    st.divider()

    # =========================
    # ì§ˆë¬¸
    # =========================
    q1 = st.radio("1ï¸âƒ£ ë¬¸ì œ ìƒí™©ì´ ìƒê¸°ë©´ ë‹¹ì‹ ì€?",
        ["í˜¼ì ê³±ì”¹ìœ¼ë©° í•´ê²°ì±…ì„ ì°¾ëŠ”ë‹¤", "ê°ì •ì ìœ¼ë¡œ ë¨¼ì € ë°˜ì‘í•œë‹¤", "ëª¸ì´ ë¨¼ì € ì›€ì§ì¸ë‹¤", "ìƒí™©ì„ ì›ƒìŒìœ¼ë¡œ ë„˜ê¸´ë‹¤"])

    q2 = st.radio("2ï¸âƒ£ ë‹¹ì‹ ì´ ì˜í™” ì† ì£¼ì¸ê³µì´ë¼ë©´?",
        ["í‰ë²”í•œ ì¼ìƒ ì† ì¸ë¬¼", "ì‚¬ë‘ì´ë‚˜ ê´€ê³„ë¡œ í”ë“¤ë¦¬ëŠ” ì¸ë¬¼", "ìœ„í—˜í•œ ìƒí™©ì— ë†“ì¸ ì¸ë¬¼", "ì„¸ìƒê³¼ ì–´ë”˜ê°€ ì–´ê¸‹ë‚œ ì¸ë¬¼"])

    q3 = st.radio("3ï¸âƒ£ ì£¼ë³€ ì‚¬ëŒë“¤ì´ ìì£¼ í•˜ëŠ” ë§ì€?",
        ["ìƒê°ì´ ë§ë‹¤", "ì •ì´ ë§ë‹¤", "í–‰ë™ë ¥ì´ ì¢‹ë‹¤", "ë…íŠ¹í•˜ë‹¤"])

    q4 = st.radio("4ï¸âƒ£ ë‹¹ì‹ ì˜ ì¸ìƒ ì˜í™” ì£¼ì¸ê³µì€?",
        ["í˜„ì‹¤ì ì¸ ê³ ë¯¼ì„ í•˜ëŠ” ì‚¬ëŒ", "ìƒì²˜ë°›ê³  ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒ", "ì‹¸ìš°ê³  ë„ë§ì¹˜ê³  ê·¹ë³µí•˜ëŠ” ì‚¬ëŒ", "ìê¸°ë§Œì˜ ì„¸ê³„ê°€ ìˆëŠ” ì‚¬ëŒ"])

    q5 = st.radio("5ï¸âƒ£ ë¶„ìœ„ê¸°ë¡œ ë” ëŒë¦¬ëŠ” ì˜í™”ëŠ”?",
        ["ì”ì”í•˜ê³  í˜„ì‹¤ì ì¸", "ê°ì •ì ìœ¼ë¡œ ëª°ì…ë˜ëŠ”", "ê¸´ì¥ê° ë„˜ì¹˜ëŠ”", "ëª½í™˜ì ì´ê³  ë‚¯ì„ "])

    q6 = st.radio("6ï¸âƒ£ ë‹¹ì‹ ì€ ì–´ë–¤ ì—”ë”©ì´ ë” ë‹¹ì‹ ë‹µë‚˜ìš”?",
        ["í˜„ì‹¤ì€ ê·¸ëŒ€ë¡œì§€ë§Œ ë‚´ê°€ ë³€í•œë‹¤", "ê´€ê³„ê°€ ì •ë¦¬ëœë‹¤", "ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì•ìœ¼ë¡œ ë‚˜ì•„ê°„ë‹¤", "ëª…í™•í•˜ì§€ ì•Šì•„ë„ ê´œì°®ë‹¤"])

    q7 = st.radio("7ï¸âƒ£ ì˜í™” ì£¼ì¸ê³µì—ê²Œ ì¤‘ìš”í•œ ê²ƒì€?",
        ["ìê¸° ì´í•´", "ì‚¬ë‘ê³¼ ê´€ê³„", "ìƒì¡´ê³¼ ì„ íƒ", "ì •ì²´ì„±ê³¼ ììœ "])

    q8 = st.radio("8ï¸âƒ£ ë‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œë¥¼ ì–´ë–»ê²Œ ìƒê°í•˜ë‚˜ìš”?",
        ["í˜„ì‹¤ì ì¸ ê´€ì°°ì", "ê°ì •ì ì¸ ì‚¬ëŒ", "í–‰ë™íŒŒ", "ì´ë°©ì¸ ê°™ì€ ì¡´ì¬"])

    # =========================
    # ê²°ê³¼ ë²„íŠ¼
    # =========================
    if st.button("ğŸ¬ ë‚˜ì™€ ë‹®ì€ ì£¼ì¸ê³µ ì°¾ê¸°"):
        if not tmdb_api_key:
            st.error("TMDB API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            # ===== ê¸°ì¡´ ë¡œì§ (ë³€ê²½ ì—†ìŒ) =====
            archetypes = {
                "í˜„ì‹¤í˜• ê´€ì°°ì": 0,
                "ê°ì • ëª°ì…í˜•": 0,
                "í–‰ë™íŒŒ í•´ê²°ì‚¬": 0,
                "ëª½ìƒê°€ / ì´ë°©ì¸": 0,
                "ìœ ì¾Œí•œ ìƒì¡´ì": 0
            }

            answers = [q1, q2, q3, q4, q5, q6, q7, q8]

            for a in answers:
                if a in ["í˜¼ì ê³±ì”¹ìœ¼ë©° í•´ê²°ì±…ì„ ì°¾ëŠ”ë‹¤", "í‰ë²”í•œ ì¼ìƒ ì† ì¸ë¬¼", "ìƒê°ì´ ë§ë‹¤", "í˜„ì‹¤ì ì¸ ê³ ë¯¼ì„ í•˜ëŠ” ì‚¬ëŒ", "ì”ì”í•˜ê³  í˜„ì‹¤ì ì¸", "í˜„ì‹¤ì€ ê·¸ëŒ€ë¡œì§€ë§Œ ë‚´ê°€ ë³€í•œë‹¤", "ìê¸° ì´í•´", "í˜„ì‹¤ì ì¸ ê´€ì°°ì"]:
                    archetypes["í˜„ì‹¤í˜• ê´€ì°°ì"] += 1
                if a in ["ê°ì •ì ìœ¼ë¡œ ë¨¼ì € ë°˜ì‘í•œë‹¤", "ì‚¬ë‘ì´ë‚˜ ê´€ê³„ë¡œ í”ë“¤ë¦¬ëŠ” ì¸ë¬¼", "ì •ì´ ë§ë‹¤", "ê°ì •ì ìœ¼ë¡œ ëª°ì…ë˜ëŠ”", "ê´€ê³„ê°€ ì •ë¦¬ëœë‹¤", "ì‚¬ë‘ê³¼ ê´€ê³„", "ê°ì •ì ì¸ ì‚¬ëŒ"]:
                    archetypes["ê°ì • ëª°ì…í˜•"] += 1
                if a in ["ëª¸ì´ ë¨¼ì € ì›€ì§ì¸ë‹¤", "ìœ„í—˜í•œ ìƒí™©ì— ë†“ì¸ ì¸ë¬¼", "í–‰ë™ë ¥ì´ ì¢‹ë‹¤", "ê¸´ì¥ê° ë„˜ì¹˜ëŠ”", "ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì•ìœ¼ë¡œ ë‚˜ì•„ê°„ë‹¤", "ìƒì¡´ê³¼ ì„ íƒ", "í–‰ë™íŒŒ"]:
                    archetypes["í–‰ë™íŒŒ í•´ê²°ì‚¬"] += 1
                if a in ["ì„¸ìƒê³¼ ì–´ë”˜ê°€ ì–´ê¸‹ë‚œ ì¸ë¬¼", "ë…íŠ¹í•˜ë‹¤", "ëª½í™˜ì ì´ê³  ë‚¯ì„ ", "ëª…í™•í•˜ì§€ ì•Šì•„ë„ ê´œì°®ë‹¤", "ì •ì²´ì„±ê³¼ ììœ ", "ì´ë°©ì¸ ê°™ì€ ì¡´ì¬"]:
                    archetypes["ëª½ìƒê°€ / ì´ë°©ì¸"] += 1
                if a == "ìƒí™©ì„ ì›ƒìŒìœ¼ë¡œ ë„˜ê¸´ë‹¤":
                    archetypes["ìœ ì¾Œí•œ ìƒì¡´ì"] += 2

            selected_type = max(archetypes, key=archetypes.get)

            type_to_genre = {
                "í˜„ì‹¤í˜• ê´€ì°°ì": 18,
                "ê°ì • ëª°ì…í˜•": 10749,
                "í–‰ë™íŒŒ í•´ê²°ì‚¬": 28,
                "ëª½ìƒê°€ / ì´ë°©ì¸": 14,
                "ìœ ì¾Œí•œ ìƒì¡´ì": 35
            }

            url = (
                f"https://api.themoviedb.org/3/discover/movie"
                f"?api_key={tmdb_api_key}"
                f"&with_genres={type_to_genre[selected_type]}"
                f"&language=ko-KR"
                f"&sort_by=vote_average.desc"
                f"&vote_count.gte=100"
            )

            movies = requests.get(url).json().get("results", [])[:10]

            # ê²°ê³¼ ì €ì¥ & í˜ì´ì§€ ì „í™˜
            st.session_state.result_data = (selected_type, movies)
            st.session_state.page = "result"
            st.rerun()

# ======================================================
# ğŸ¥ ê²°ê³¼ í™”ë©´
# ======================================================
if st.session_state.page == "result":

    selected_type, movies = st.session_state.result_data

    with st.spinner("ğŸ¬ ë‹¹ì‹ ê³¼ ë‹®ì€ ì˜í™” ì£¼ì¸ê³µì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤..."):
        time.sleep(1.5)

    st.balloons()

    st.title("ğŸ¬ ë¶„ì„ ê²°ê³¼")
    st.write(f"ë‹¹ì‹ ì€ **{selected_type}** ì£¼ì¸ê³µê³¼ ê°€ì¥ ë‹®ì•„ ìˆì–´ìš”.")
    st.divider()

    for movie in movies:
        col1, col2 = st.columns([1, 3])

        with col1:
            if movie.get("poster_path"):
                st.image("https://image.tmdb.org/t/p/w500" + movie["poster_path"], use_column_width=True)

        with col2:
            st.markdown(f"### {movie.get('title')}")
            st.write(f"â­ í‰ì : {movie.get('vote_average')}")
            st.write(movie.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."))
            st.caption(f"ğŸ’¡ ì¶”ì²œ ì´ìœ : ì´ ì˜í™”ì˜ ì£¼ì¸ê³µì€ **{selected_type}** ì„±í–¥ì„ ê°€ì§„ ì¸ë¬¼ì…ë‹ˆë‹¤.")

        st.divider()

    if st.button("ğŸ” ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°"):
        st.session_state.page = "test"
        st.rerun()
